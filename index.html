<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>제주도 실시간 버스 시각화 (Leaflet)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { width: 100%; height: 700px; }
    </style>
</head>
<body>
    <h2>제주도 실시간 버스 시각화</h2>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // 지도 생성
        var map = L.map('map').setView([33.4996, 126.5312], 11);

        // OSM 타일
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var busMarkers = [];
        var routeColors = {}; // 노선별 색상

        // 랜덤 색상 생성
        function getRandomColor() {
            return '#' + Math.floor(Math.random()*16777215).toString(16);
        }

        async function fetchAllBuses() {
            const serviceKey = 'GcNpG93UDg3EHP+ohOowQjNCdDfacM10oBBDi1ne1xUAmzFAoCLA/s7rn4W34hZw6lCOHJBl3tRj0sgbFflQ4w==';

            // 제주도 모든 노선 ID (예시) → 실제는 정식 노선 ID 리스트로 변경 가능
            const routeIds = ['100100003','100100004','100100005','100100006'];

            // 기존 마커 제거
            busMarkers.forEach(marker => map.removeLayer(marker));
            busMarkers = [];

            for (let routeId of routeIds) {
                // 노선별 색상 할당
                if (!routeColors[routeId]) routeColors[routeId] = getRandomColor();

                const url = `http://ws.bus.go.kr/api/rest/buspos/getBusPosByRtid?ServiceKey=${encodeURIComponent(serviceKey)}&busRouteId=${routeId}`;
                try {
                    const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                    const data = await response.json();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(data.contents,"application/xml");
                    const buses = xmlDoc.getElementsByTagName('bus');

                    for (let i = 0; i < buses.length; i++) {
                        const lat = parseFloat(buses[i].getElementsByTagName('gpsY')[0].textContent);
                        const lng = parseFloat(buses[i].getElementsByTagName('gpsX')[0].textContent);
                        const busNo = buses[i].getElementsByTagName('plainNo')[0].textContent;

                        // 직사각형 마커 생성
                        const marker = L.rectangle(
                            [[lat-0.0002, lng-0.0005],[lat+0.0002, lng+0.0005]],
                            {color: routeColors[routeId], weight:1, fillOpacity:0.7}
                        ).addTo(map).bindPopup(`<b>노선:</b> ${routeId}<br><b>버스 번호:</b> ${busNo}`);

                        busMarkers.push(marker);
                    }

                } catch (error) {
                    console.error(`노선 ${routeId} 버스 로딩 실패:`, error);
                }
            }
        }

        // 초기 로드
        fetchAllBuses();
        // 10초마다 갱신
        setInterval(fetchAllBuses, 10000);

        // 줌/이동 시 마커 최적화
        map.on('zoomend moveend', () => {
            // 현재는 간단히 모든 마커 표시 → 필요시 cluster plugin 적용 가능
        });

    </script>
</body>
</html>
