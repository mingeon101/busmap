<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>제주도 버스 실시간 위치 & 사용자 위치</title>
    <style>
        #map {
            width: 100%;
            height: 600px;
        }
    </style>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_JS_KEY"></script>
</head>
<body>
    <h2>제주도 버스 실시간 위치 & 내 위치</h2>
    <div id="map"></div>

    <script>
        var mapContainer = document.getElementById('map'),
            mapOption = {
                center: new kakao.maps.LatLng(33.4996, 126.5312),
                level: 10
            };
        var map = new kakao.maps.Map(mapContainer, mapOption);

        var busMarkers = [];
        var userMarker = null;

        // 사용자 위치 표시
        function showUserLocation(position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;

            if (userMarker) {
                userMarker.setPosition(new kakao.maps.LatLng(lat, lng));
            } else {
                userMarker = new kakao.maps.Marker({
                    map: map,
                    position: new kakao.maps.LatLng(lat, lng),
                    title: "내 위치",
                    image: new kakao.maps.MarkerImage(
                        'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(
                            `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20">
                                <circle cx="10" cy="10" r="8" fill="blue" stroke="black" stroke-width="1"/>
                            </svg>`
                        ),
                        new kakao.maps.Size(20,20),
                        {offset: new kakao.maps.Point(10,10)}
                    )
                });
            }
        }

        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(showUserLocation);
        } else {
            alert("위치 정보 사용 불가");
        }

        // 버스 데이터 가져오기
        async function fetchAllBuses() {
            const serviceKey = 'GcNpG93UDg3EHP+ohOowQjNCdDfacM10oBBDi1ne1xUAmzFAoCLA/s7rn4W34hZw6lCOHJBl3tRj0sgbFflQ4w==';
            
            const routeIds = ['100100003', '100100004', '100100005']; // 제주도 예시 노선 ID

            // 기존 마커 제거
            busMarkers.forEach(marker => marker.setMap(null));
            busMarkers = [];

            for (let routeId of routeIds) {
                const url = `http://ws.bus.go.kr/api/rest/buspos/getBusPosByRtid?ServiceKey=${encodeURIComponent(serviceKey)}&busRouteId=${routeId}`;
                try {
                    const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                    const data = await response.json();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(data.contents, "application/xml");
                    const buses = xmlDoc.getElementsByTagName('bus');

                    for (let i = 0; i < buses.length; i++) {
                        const lat = buses[i].getElementsByTagName('gpsY')[0].textContent;
                        const lng = buses[i].getElementsByTagName('gpsX')[0].textContent;
                        const busNo = buses[i].getElementsByTagName('plainNo')[0].textContent;

                        // 직사각형 마커
                        var marker = new kakao.maps.Marker({
                            map: map,
                            position: new kakao.maps.LatLng(lat, lng),
                            title: busNo,
                            image: new kakao.maps.MarkerImage(
                                'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(
                                    `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="10">
                                        <rect width="20" height="10" fill="red" stroke="black" stroke-width="1"/>
                                    </svg>`
                                ),
                                new kakao.maps.Size(20,10),
                                {offset: new kakao.maps.Point(10,5)}
                            )
                        });

                        // 인포윈도우
                        var infowindow = new kakao.maps.InfoWindow({
                            content: `<div style="padding:5px;">버스 번호: ${busNo}</div>`
                        });
                        kakao.maps.event.addListener(marker, 'click', function() {
                            infowindow.open(map, marker);
                        });

                        // 사용자 위치와 거리 계산
                        if (userMarker) {
                            var distance = kakao.maps.services.Coords.distance(
                                new kakao.maps.LatLng(lat, lng),
                                userMarker.getPosition()
                            );
                            console.log(`버스 ${busNo}와 사용자 거리: ${Math.round(distance)}m`);
                        }

                        busMarkers.push(marker);
                    }

                } catch (error) {
                    console.error('버스 정보 로딩 실패:', error);
                }
            }
        }

        fetchAllBuses();
        setInterval(fetchAllBuses, 10000); // 10초마다 갱신
    </script>
</body>
</html>
