<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>제주도 실시간 버스 지도</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { width: 100%; height: 700px; }
    </style>
</head>
<body>
    <h2>제주도 실시간 버스 지도</h2>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([33.4996, 126.5312], 11);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var busMarkers = [];

        async function fetchBuses() {
            const serviceKey = "GcNpG93UDg3EHP+ohOowQjNCdDfacM10oBBDi1ne1xUAmzFAoCLA/s7rn4W34hZw6lCOHJBl3tRj0sgbFflQ4w==";
            const cityCode = 39;
            const routeId = "JJe0001"; // ⚠️ 실제 노선 ID 필요 (예: 1100번 노선 ID)

            const url = `https://api.allorigins.win/get?url=${encodeURIComponent(
                `http://apis.data.go.kr/1613000/BusLcInfoInqireService/getBusLcList?serviceKey=${serviceKey}&cityCode=${cityCode}&routeId=${routeId}`
            )}`;

            // 이전 마커 제거
            busMarkers.forEach(m => map.removeLayer(m));
            busMarkers = [];

            try {
                const response = await fetch(url);
                const data = await response.json();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(data.contents, "application/xml");
                const buses = xmlDoc.getElementsByTagName("item");

                for (let i = 0; i < buses.length; i++) {
                    const lat = parseFloat(buses[i].getElementsByTagName("gpsY")[0].textContent);
                    const lng = parseFloat(buses[i].getElementsByTagName("gpsX")[0].textContent);
                    const busNo = buses[i].getElementsByTagName("vehId")[0].textContent;

                    if (!isNaN(lat) && !isNaN(lng)) {
                        const marker = L.marker([lat, lng]).bindPopup(`버스 번호: ${busNo}`);
                        marker.addTo(map);
                        busMarkers.push(marker);
                    }
                }
            } catch (e) {
                console.error("버스 데이터 불러오기 오류:", e);
            }
        }

        fetchBuses();
        setInterval(fetchBuses, 10000); // 10초마다 새로고침
    </script>
</body>
</html>
