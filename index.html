<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>제주도 실시간 버스 지도 (Cluster + 범례)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        #map { width: 100%; height: 700px; }
        .legend { background: white; padding: 10px; line-height: 1.5; }
        .legend-color { display:inline-block; width:15px; height:15px; margin-right:5px; }
    </style>
</head>
<body>
    <h2>제주도 실시간 버스 지도 (Cluster + 범례)</h2>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script>
        var map = L.map('map').setView([33.4996, 126.5312], 11);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var busMarkers = L.markerClusterGroup(); // 클러스터 그룹
        map.addLayer(busMarkers);

        var routeColors = {};
        var routeIds = ['100100003','100100004','100100005','100100006']; // 예시 제주도 노선

        function getRandomColor() {
            return '#' + Math.floor(Math.random()*16777215).toString(16);
        }

        // 범례 추가
        var legend = L.control({position: 'bottomright'});
        legend.onAdd = function() {
            var div = L.DomUtil.create('div','legend');
            div.innerHTML = '<b>노선 색상</b><br>';
            routeIds.forEach(id => {
                if(!routeColors[id]) routeColors[id] = getRandomColor();
                div.innerHTML += `<div><span class="legend-color" style="background:${routeColors[id]}"></span>${id}</div>`;
            });
            return div;
        };
        legend.addTo(map);

        async function fetchAllBuses() {
            const serviceKey = 'GcNpG93UDg3EHP+ohOowQjNCdDfacM10oBBDi1ne1xUAmzFAoCLA/s7rn4W34hZw6lCOHJBl3tRj0sgbFflQ4w==';

            // 기존 마커 제거
            busMarkers.clearLayers();

            for (let routeId of routeIds) {
                if(!routeColors[routeId]) routeColors[routeId] = getRandomColor();
                const url = `http://ws.bus.go.kr/api/rest/buspos/getBusPosByRtid?ServiceKey=${encodeURIComponent(serviceKey)}&busRouteId=${routeId}`;
                try {
                    const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                    const data = await response.json();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(data.contents,"application/xml");
                    const buses = xmlDoc.getElementsByTagName('bus');

                    for (let i = 0; i < buses.length; i++) {
                        const lat = parseFloat(buses[i].getElementsByTagName('gpsY')[0].textContent);
                        const lng = parseFloat(buses[i].getElementsByTagName('gpsX')[0].textContent);
                        const busNo = buses[i].getElementsByTagName('plainNo')[0].textContent;

                        // 클러스터용 마커 생성
                        const marker = L.marker([lat, lng], {
                            title: busNo,
                            icon: L.divIcon({
                                className: '',
                                html: `<div style="width:12px;height:12px;background:${routeColors[routeId]};border:1px solid black;"></div>`,
                                iconSize: [12,12]
                            })
                        }).bindPopup(`<b>노선:</b> ${routeId}<br><b>버스 번호:</b> ${busNo}`);

                        busMarkers.addLayer(marker);
                    }

                } catch (error) {
                    console.error(`노선 ${routeId} 버스 로딩 실패:`, error);
                }
            }
        }

        fetchAllBuses();
        setInterval(fetchAllBuses, 10000); // 10초마다 갱신

    </script>
</body>
</html>
